@page "/reporte-saldos"
@inject SupabaseService Supabase
@inject IJSRuntime JS
<h3>📊 Listado de Saldos</h3>

@if (saldos is null)
{
    <p>Cargando...</p>
}
else if (saldos.Count == 0)
{
    <p>No hay movimientos registrados.</p>
}
else
{
    <table class="table table-striped table-bordered">
        <thead class="table-primary">
            <tr>
                <th>Apellido</th>
                <th>Nombre</th>
                <th class="text-end">Total Debe</th>
                <th class="text-end">Total Haber</th>
                <th class="text-end">Saldo Actual</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var s in saldos)
            {
                var saldo = s.TotalDebe - s.TotalHaber;
                <tr>
                    <td>@s.Apellido</td>
                    <td>@s.Nombre</td>
                    <td class="text-end">@s.TotalDebe.ToString("N2")</td>
                    <td class="text-end">@s.TotalHaber.ToString("N2")</td>
                    <td class="text-end fw-bold">@saldo.ToString("N2")</td>
                </tr>
            }
            <tr class="table-secondary fw-bold">
                <td colspan="2" class="text-end">Totales:</td>
                <td class="text-end">@saldos.Sum(s => s.TotalDebe).ToString("N2")</td>
                <td class="text-end">@saldos.Sum(s => s.TotalHaber).ToString("N2")</td>
                <td class="text-end">@saldos.Sum(s => s.TotalDebe - s.TotalHaber).ToString("N2")</td>
            </tr>

        </tbody>
    </table>

    <div class="mt-3">
       <button class="btn btn-outline-success me-2" @onclick="ExportarExcel">
  <i class="bi bi-file-earmark-excel"></i> Excel
</button>

        <button class="btn btn-outline-danger me-2" @onclick="ExportarPDF">
  <i class="bi bi-file-earmark-pdf"></i> PDF
</button>

    </div>
}

@code {
    private List<(string Apellido, string Nombre, decimal TotalDebe, decimal TotalHaber)>? saldos;

    protected override async Task OnInitializedAsync()
    {
        saldos = await Supabase.ObtenerSaldosAsync();
    }

    private async Task ExportarExcel()
    {
        var sep = System.Globalization.CultureInfo.CurrentCulture.TextInfo.ListSeparator;
        var sb = new System.Text.StringBuilder();

        sb.AppendLine($"Apellido{sep}Nombre{sep}Total Debe{sep}Total Haber{sep}Saldo");

        foreach (var s in saldos!)
        {
            var saldo = s.TotalDebe - s.TotalHaber;
            sb.AppendLine($"{s.Apellido}{sep}{s.Nombre}{sep}{s.TotalDebe:N2}{sep}{s.TotalHaber:N2}{sep}{saldo:N2}");
        }

        sb.AppendLine($"{sep}{sep}{saldos.Sum(s => s.TotalDebe):N2}{sep}{saldos.Sum(s => s.TotalHaber):N2}{sep}{saldos.Sum(s => s.TotalDebe - s.TotalHaber):N2}");
        var bytes = System.Text.Encoding.UTF8.GetBytes(sb.ToString());
        var base64 = Convert.ToBase64String(bytes);
        var nombreArchivo = $"Saldos_al_{DateTime.Now:yyyyMMddHHmm}.csv";
        await JS.InvokeVoidAsync("descargarArchivo", nombreArchivo, "text/csv", base64);
    }


    private async Task ExportarPDF()
    {
        using var ms = new System.IO.MemoryStream();
        var doc = new iTextSharp.text.Document(iTextSharp.text.PageSize.A4, 40, 40, 40, 40);
        iTextSharp.text.pdf.PdfWriter.GetInstance(doc, ms);
        doc.Open();

        var fontTitulo = iTextSharp.text.FontFactory.GetFont("Helvetica", 14, iTextSharp.text.Font.BOLD);
        var fontTexto = iTextSharp.text.FontFactory.GetFont("Helvetica", 10);

        doc.Add(new iTextSharp.text.Paragraph("Listado de Saldos", fontTitulo));
        doc.Add(new iTextSharp.text.Paragraph($"Fecha: {DateTime.Now:dd/MM/yyyy}\n\n", fontTexto));

        var table = new iTextSharp.text.pdf.PdfPTable(5);
        table.WidthPercentage = 100;
        table.SetWidths(new float[] { 2, 2, 1.2f, 1.2f, 1.2f });

        void AddCell(string text, bool bold = false, int align = iTextSharp.text.Element.ALIGN_LEFT)
        {
            var font = bold ? iTextSharp.text.FontFactory.GetFont("Helvetica", 10, iTextSharp.text.Font.BOLD)
                            : fontTexto;
            var cell = new iTextSharp.text.pdf.PdfPCell(new iTextSharp.text.Phrase(text, font));
            cell.HorizontalAlignment = align;
            table.AddCell(cell);
        }

        AddCell("Apellido", true);
        AddCell("Nombre", true);
        AddCell("Total Debe", true, iTextSharp.text.Element.ALIGN_RIGHT);
        AddCell("Total Haber", true, iTextSharp.text.Element.ALIGN_RIGHT);
        AddCell("Saldo", true, iTextSharp.text.Element.ALIGN_RIGHT);

        foreach (var s in saldos!)
        {
            var saldo = s.TotalDebe - s.TotalHaber;
            AddCell(s.Apellido);
            AddCell(s.Nombre);
            AddCell($"{s.TotalDebe:N2}", false, iTextSharp.text.Element.ALIGN_RIGHT);
            AddCell($"{s.TotalHaber:N2}", false, iTextSharp.text.Element.ALIGN_RIGHT);
            AddCell($"{saldo:N2}", false, iTextSharp.text.Element.ALIGN_RIGHT);
        }

        AddCell("Totales:", true, iTextSharp.text.Element.ALIGN_RIGHT);
        AddCell("");
        AddCell($"{saldos.Sum(s => s.TotalDebe):N2}", true, iTextSharp.text.Element.ALIGN_RIGHT);
        AddCell($"{saldos.Sum(s => s.TotalHaber):N2}", true, iTextSharp.text.Element.ALIGN_RIGHT);
        AddCell($"{saldos.Sum(s => s.TotalDebe - s.TotalHaber):N2}", true, iTextSharp.text.Element.ALIGN_RIGHT);

        doc.Add(table);
        doc.Close();

        var base64 = Convert.ToBase64String(ms.ToArray());
        var nombreArchivo = $"Saldos_al_{DateTime.Now:yyyyMMddHHmm}.pdf";
        await JS.InvokeVoidAsync("descargarArchivo", nombreArchivo, "application/pdf", base64);
        
    }

}
